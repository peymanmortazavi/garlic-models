<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>Garlic Model: Encoding and Decoding</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygenextra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="topbanner"><a href="https://github.com/peymanmortazavi/garlic-models" title="Garlic Model GitHub"><i class="githublogo"></i></a></div>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_runner_work_garlic-models_garlic-models_docs_pages_Encoding.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Encoding and Decoding </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Related file: <a class="el" href="encoding_8h.html" title="Contains classes and methods for defining and using encoders/decoders for various types.">garlic/encoding.h</a></p>
<p>One of the important things that is needed when dealing with data containers is to be able to decode them into other types and encode custom types to a container either to serialize and deserialize or for other needs like loading a configuration file and use to set up internal objects according to them.</p>
<p>There are libraries that offer macros that help with this. At this time, garlic does <b>NOT</b> have any macros that.</p>
<p>Instead it provides means to define how an object can be decoded and encoded and provide some helper functions to make it easier.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Encoding</h1>
<p>There are two ways, in order of precedence that one can define how an object can be encoded.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
1. Provide an encode function in a specialization of garlic::coder&lt;T&gt; like below:</h3>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>garlic {</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span>&lt;&gt;</div>
<div class="line">    <span class="keyword">struct </span>coder&lt;int&gt; {</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">template</span>&lt;GARLIC_REF Layer&gt;</div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">void</span> encode(Layer&amp;&amp; layer, <span class="keywordtype">int</span> value) {</div>
<div class="line">            <span class="comment">// populate the layer here.</span></div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md3"></a>
2. static encoder function for custom classes:</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span>User {</div>
<div class="line">    std::string name;</div>
<div class="line">    <span class="keywordtype">int</span> score;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span>&lt;GARLIC_REF Layer&gt;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> encode(Layer&amp;&amp; layer, <span class="keyword">const</span> User&amp; user) {</div>
<div class="line">        layer.set_object();</div>
<div class="line">        layer.add_member(<span class="stringliteral">&quot;name&quot;</span>, user.name);</div>
<div class="line">        layer.add_member(<span class="stringliteral">&quot;score&quot;</span>, user.score);</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><blockquote class="doxtable">
<p><b>NOTE</b> <b>garlic::encode()</b> method always prefers the first method (using <b>garlic::coder&lt;T, Layer&gt;</b>) over the second one. </p>
</blockquote>
<p>Once there is an encoder available, you can use the <b>garlic::encode()</b> method.</p>
<div class="fragment"><div class="line"><a class="code" href="clove_8h.html#a510118787dcd3f227971552ffa69d6f7">garlic::CloveDocument</a> doc;</div>
<div class="line">User user {<span class="stringliteral">&quot;Zombie&quot;</span>, 180};</div>
<div class="line"><a class="code" href="encoding_8h.html#a77e0bcf3da4a7087cc834da98f7f6137">garlic::encode</a>(doc, user);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Decoding</h1>
<p>This is very similar to how encoding is done but there are some differences.</p>
<p>There are three difference primary ways, in order of precedence to define how to decode a type:</p>
<h3><a class="anchor" id="autotoc_md5"></a>
1. Provide a decode function in a specialization of garlic::coder&lt;T&gt; like below:</h3>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>garlic {</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">template</span>&lt;&gt;</div>
<div class="line">    <span class="keyword">struct </span>coder&lt;User&gt; {</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">template</span>&lt;GARLIC_VIEW Layer&gt;</div>
<div class="line">        <span class="keyword">static</span> User decode(Layer&amp;&amp; layer) {</div>
<div class="line">            <span class="keywordflow">return</span> User {</div>
<div class="line">                .name = get&lt;std::string&gt;(layer, <span class="stringliteral">&quot;name&quot;</span>),</div>
<div class="line">                .score = get&lt;int&gt;(layer, <span class="stringliteral">&quot;score)</span></div>
<div class="line"><span class="stringliteral">            };</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    };</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">}</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md6"></a>
2. Provide a static decoder function for custom classes:</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span>User {</div>
<div class="line">    std::string name;</div>
<div class="line">    <span class="keywordtype">int</span> score;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Layer&gt;</div>
<div class="line">    <span class="keyword">static</span> User decode(Layer&amp;&amp; layer) {</div>
<div class="line">        <span class="keywordflow">return</span> User {</div>
<div class="line">            .name = get&lt;std::string&gt;(layer, <span class="stringliteral">&quot;name&quot;</span>),</div>
<div class="line">            .score = get&lt;int&gt;(layer, <span class="stringliteral">&quot;score&quot;</span>)</div>
<div class="line">        };</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
3. Provide a layer constructor in custom classes.</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span>User {</div>
<div class="line">    std::string name;</div>
<div class="line">    <span class="keywordtype">int</span> score;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span>&lt;GARLIC_VIEW Layer&gt;</div>
<div class="line">    User(Layer&amp;&amp; layer) : name(get(layer, <span class="stringliteral">&quot;name&quot;</span>)), score(get(layer, <span class="stringliteral">&quot;score&quot;</span>)) {}</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8"></a>
Safe Decoding</h3>
<p>Certainly, there are times that a class/type cannot be created from a layer because the layer has missing critical information or has invalid values. To cover this, one can use garlic::safe_decode() method. This method calls a callback function if and only if a type is properly decoded from a layer. Similar to garlic::decode() methods, one can define safe_decode methods using either of these ways in order of precedence.</p>
<h4><a class="anchor" id="autotoc_md9"></a>
1. Provide a safe_decode function in a specialization of garlic::coder&lt;T&gt; like below:</h4>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>garlic::coder&lt;User&gt; {</div>
<div class="line">    <span class="keyword">template</span>&lt;GARLIC_VIEW Layer, <span class="keyword">typename</span> Callable&gt;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> safe_decode(Layer&amp;&amp; layer, Callable&amp;&amp; cb) {</div>
<div class="line">        User user;</div>
<div class="line">        <span class="comment">// setup user here.</span></div>
<div class="line">        <span class="comment">// if user is not valid, return to skip calling cb with the user.</span></div>
<div class="line">        cb(std::move(user));  <span class="comment">// if user is valid.</span></div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md10"></a>
2. Provide a static safe_decoder function for custom classes:</h4>
<div class="fragment"><div class="line"><span class="keyword">struct </span>User {</div>
<div class="line">    std::string name;</div>
<div class="line">    <span class="keywordtype">int</span> score;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Layer, <span class="keyword">typename</span> Callable&gt;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> safe_decode(Layer&amp;&amp; layer, Callable&amp;&amp; cb) {</div>
<div class="line">        User user;</div>
<div class="line">        <span class="comment">// if we can&#39;t create a user from layer, return without calling cb</span></div>
<div class="line">        cb(std::move(user));  <span class="comment">// otherwise call cb with user!</span></div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md11"></a>
Recommendations</h3>
<p>In order to cover various different cases, there are various ways to define how encoding and decoding should behave for different types. However, there are some recommendations:</p>
<h4><a class="anchor" id="autotoc_md12"></a>
For custom classes, it's more clean and easy to understand to just provide the static encode and decode functions:</h4>
<div class="fragment"><div class="line"><span class="keyword">struct </span>User {</div>
<div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Layer&gt;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> encode(Layer&amp;&amp; layer, <span class="keyword">const</span> User&amp; user);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Layer&gt;</div>
<div class="line">    <span class="keyword">static</span> User decode(Layer&amp;&amp; layer);</div>
<div class="line">};</div>
</div><!-- fragment --><p>This way, it's easy to read the code and find the encoder and decoders. Defining a layer constructor might make sense in some scenarios but for small data structures it'll force you to define other constructors as well so you'd have to explicitly define move and copy constructors as well. If this is not possible because you already have this method reserved for some other function, use the <code>garlic::coder&lt;T&gt;</code> specialization.</p>
<h4><a class="anchor" id="autotoc_md13"></a>
Use GARLIC_VIEW and GARLIC_REF instead of typename:</h4>
<p>These macros end up being <a class="el" href="classgarlic_1_1ViewLayer.html" title="Concept for reading values from containers.">garlic::ViewLayer</a> and <a class="el" href="classgarlic_1_1RefLayer.html" title="Concept for reading from and writing to containers.">garlic::RefLayer</a> when concepts are available and <em>typename</em> otherwise. Some language servers can provide auto-completion for these concepts and you'll get more clear error messages if things go wrong.</p>
<h4><a class="anchor" id="autotoc_md14"></a>
Be careful using garlic::get()</h4>
<p><code><a class="el" href="utility_8h.html#a8d862d6858398925095a5aeeb6f363c0">garlic::get()</a></code> method is a great utility but it makes a lot of assumptions about the layer that may not be true. Use them if you are certain there exists a key and it can be decoded.</p>
<p>If there is doubt, use the safe methods like <code><a class="el" href="utility_8h.html#a55262a00ca6aecc256d12e69f27b2259">garlic::safe_get()</a></code> and use defaults or handle failures properly.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>User {</div>
<div class="line">    std::string name;</div>
<div class="line">    <span class="keywordtype">int</span> score;</div>
<div class="line">  </div>
<div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Layer, <span class="keyword">typename</span> Callback&gt;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> safe_decode(Layer&amp;&amp; layer, Callback&amp;&amp; cb) {</div>
<div class="line">      User user {</div>
<div class="line">        .name = safe_get(layer, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line">        .score = safe_get(layer, <span class="stringliteral">&quot;score&quot;</span>, 0)</div>
<div class="line">      };</div>
<div class="line">      <span class="keywordflow">if</span> (user.name.empty())  <span class="comment">// invalid User!</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">      cb(std::move(user));</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><p>Ideal is to provide both safe_decode and decode methods so the proper method can be used in different contexts. For instance, if you validate a config file and know an object can be decoded, no need to use safe methods and benefit from the faster but unsafe methods. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aclove_8h_html_a510118787dcd3f227971552ffa69d6f7"><div class="ttname"><a href="clove_8h.html#a510118787dcd3f227971552ffa69d6f7">garlic::CloveDocument</a></div><div class="ttdeci">GenericCloveDocument&lt; CAllocator &gt; CloveDocument</div><div class="ttdoc">A clove document (value) conforming to garlic::RefLayer.</div><div class="ttdef"><b>Definition:</b> clove.h:525</div></div>
<div class="ttc" id="aencoding_8h_html_a77e0bcf3da4a7087cc834da98f7f6137"><div class="ttname"><a href="encoding_8h.html#a77e0bcf3da4a7087cc834da98f7f6137">garlic::encode</a></div><div class="ttdeci">static std::enable_if_t&lt; internal::use_encode_layer_method&lt; Type, Layer &gt; &gt; encode(Layer &amp;&amp;layer, const Type &amp;value)</div><div class="ttdoc">Encode a value in a garlic::RefLayer.</div><div class="ttdef"><b>Definition:</b> encoding.h:314</div></div>
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
</body>
</html>
